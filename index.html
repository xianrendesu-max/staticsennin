<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>仙人Tube 完全版</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#27293d">
<link rel="manifest" href="manifest.json">
<style>
body{margin:0;background:#1e1e2f;color:#fff;font-family:sans-serif}
header{background:#27293d;padding:1em;text-align:center;font-size:1.4em}
nav{display:flex;background:#33354a}
nav button{flex:1;padding:1em;border:none;background:none;color:#aaa}
nav button.active{background:#444667;color:#fff;font-weight:bold}
main{padding:1em}
section{display:none}
section.active{display:block}

.search-box{display:flex}
.search-box input{flex:1;padding:.6em;border:none;border-radius:4px 0 0 4px}
.search-box button{padding:.6em 1em;border:none;background:#4caf50;color:#fff;border-radius:0 4px 4px 0}

.video-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1em;margin-top:1em}
.video-card{background:#2d2f44;border-radius:8px;overflow:hidden;cursor:pointer;transition:.2s}
.video-card:hover{transform:scale(1.03)}
.video-card img{width:100%}
.info{padding:.6em}
.title{font-weight:bold}
.channel{font-size:.85em;color:#aaa}

#loading{display:none;text-align:center;margin:2em}
.spinner{width:40px;height:40px;border:4px solid #555;border-top:4px solid #4caf50;border-radius:50%;animation:spin 1s linear infinite;margin:auto}
@keyframes spin{to{transform:rotate(360deg)}}

.alert{position:fixed;top:-80px;left:50%;transform:translateX(-50%);
background:#f44336;color:white;padding:1em 2em;border-radius:6px;
transition:.5s;z-index:999}
.alert.show{top:20px}
</style>
</head>

<body>
<header>仙人Tube（完全静止版）</header>

<nav>
<button id="tab-search" class="active">検索</button>
<button id="tab-history">履歴</button>
<button id="tab-fav">お気に入り</button>
</nav>

<div id="alert" class="alert">検索に失敗しました</div>

<main>
<section id="search" class="active">
<div class="search-box">
<input id="q" placeholder="検索…">
<button onclick="search()">検索</button>
</div>
<div id="loading"><div class="spinner"></div><p>検索中…</p></div>
<div id="results" class="video-list"></div>
</section>

<section id="history"><div id="history-list" class="video-list"></div></section>
<section id="fav"><div id="fav-list" class="video-list"></div></section>
</main>

<script>
const SEARCH_APIS=[
"https://pol1.iv.ggtyler.dev",
"https://youtube.mosesmang.com",
"https://iteroni.com",
"https://invidious.0011.lt",
"https://iv.melmac.space",
"https://rust.oskamp.nl"
];

const HISTORY_KEY="sennin_history";
const FAV_KEY="sennin_fav";

const results=document.getElementById("results");
const loading=document.getElementById("loading");
const alertBox=document.getElementById("alert");

function showAlert(){
 alertBox.classList.add("show");
 setTimeout(()=>alertBox.classList.remove("show"),3000);
}

async function search(){
 const q=document.getElementById("q").value.trim();
 if(!q)return;
 results.innerHTML="";
 loading.style.display="block";

 let videos=[];
 let seen=new Set();

 for(const base of SEARCH_APIS){
  try{
   const r=await fetch(`${base}/api/v1/search?q=${encodeURIComponent(q)}&type=video`);
   const d=await r.json();
   if(!Array.isArray(d))continue;
   d.forEach(v=>{
    if(!seen.has(v.videoId)){
     seen.add(v.videoId);
     videos.push(v);
    }
   });
  }catch{}
 }

 loading.style.display="none";
 if(!videos.length){showAlert();return;}

 videos.forEach(v=>{
  const c=document.createElement("div");
  c.className="video-card";
  c.innerHTML=`
   <img src="https://i.ytimg.com/vi/${v.videoId}/mqdefault.jpg">
   <div class="info">
    <div class="title">${v.title}</div>
    <div class="channel">${v.author}</div>
   </div>`;
  c.onclick=()=>{
   save(HISTORY_KEY,v);
   location.href=`watch.html?id=${v.videoId}`;
  };
  results.appendChild(c);
 });
}

function save(key,v){
 let a=JSON.parse(localStorage.getItem(key)||"[]");
 if(!a.some(x=>x.videoId===v.videoId)){
  a.unshift(v);a=a.slice(0,50);
  localStorage.setItem(key,JSON.stringify(a));
 }
}

function render(key,id){
 const el=document.getElementById(id);
 el.innerHTML="";
 JSON.parse(localStorage.getItem(key)||"[]").forEach(v=>{
  const c=document.createElement("div");
  c.className="video-card";
  c.innerHTML=`
   <img src="https://i.ytimg.com/vi/${v.videoId}/mqdefault.jpg">
   <div class="info"><div class="title">${v.title}</div></div>`;
  c.onclick=()=>location.href=`watch.html?id=${v.videoId}`;
  el.appendChild(c);
 });
}

tab-search.onclick=()=>switchTab("search");
tab-history.onclick=()=>{switchTab("history");render(HISTORY_KEY,"history-list")}
tab-fav.onclick=()=>{switchTab("fav");render(FAV_KEY,"fav-list")}

function switchTab(t){
 document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
 document.getElementById(t).classList.add("active");
 document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
 document.getElementById("tab-"+t).classList.add("active");
}

if("serviceWorker"in navigator)navigator.serviceWorker.register("service-worker.js");
</script>
</body>
</html>
